<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="murasaki's center v2 with enhanced features and performance">
    <title>murasaki's center v2 | more features unc!</title>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rubik:wght@400;700&display=swap" as="style">
    <link rel="preload" href="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js" as="script">
    <link rel="preload" href="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js" as="script">
    
    <!-- Inline critical CSS -->
    <style>
        /* Critical CSS - minimal styles needed for initial render */
        :root {
            --primary: #00a8ff;
            --secondary: #ff2d75;
            --dark: #0d1b2a;
            --light: #e0e1dd;
            --success: #4CAF50;
            --error: #f44336;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: var(--dark);
            color: var(--light);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            font-family: 'Rubik', sans-serif;
        }
        
        .auth-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .auth-container {
            max-width: 400px;
            width: 100%;
            padding: 30px;
            background: rgba(13, 27, 42, 0.95);
            border-radius: 15px;
            border: 2px solid var(--primary);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            animation: windowsFade 0.6s cubic-bezier(0.1, 0.9, 0.2, 1);
        }
        
        .auth-title {
            color: var(--primary);
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.8rem;
        }
        
        .auth-input {
            width: 100%;
            padding: 14px;
            margin-bottom: 20px;
            border-radius: 8px;
            border: 1px solid rgba(0, 168, 255, 0.3);
            background: rgba(224, 225, 221, 0.1);
            color: var(--light);
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .auth-input:focus {
            outline: none;
            box-shadow: 0 0 10px rgba(0, 168, 255, 0.5);
            border-color: var(--primary);
        }
        
        .auth-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.3s cubic-bezier(0.1, 0.9, 0.2, 1);
        }
        
        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 168, 255, 0.3);
        }
        
        .auth-status {
            padding: 12px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            display: none;
            animation: fadeIn 0.3s ease-out;
        }
        
        .auth-status.success {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
            display: block;
        }
        
        .auth-status.error {
            background: rgba(244, 67, 54, 0.1);
            color: var(--error);
            border: 1px solid var(--error);
            display: block;
        }
        
        .hidden {
            display: none;
        }
        
        /* Animation keyframes */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(10px); }
        }
        
        @keyframes windowsFade {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        /* Settings panel styles */
        .settings-panel {
            position: fixed;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100vh;
            background: rgba(13, 27, 42, 0.95);
            border-left: 2px solid var(--primary);
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
            transition: right 0.3s ease;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }
        
        .settings-panel.open {
            right: 0;
        }
        
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 168, 255, 0.3);
        }
        
        .settings-title {
            color: var(--primary);
            font-size: 1.5rem;
        }
        
        .close-settings {
            background: none;
            border: none;
            color: var(--light);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .settings-section {
            margin-bottom: 20px;
        }
        
        .settings-section h3 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
        }
        
        .settings-option label {
            color: var(--light);
            cursor: pointer;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .color-scheme-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .color-scheme-option {
            width: 100%;
            height: 40px;
            border-radius: 5px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .color-scheme-option.selected {
            border-color: var(--light);
            transform: scale(1.05);
        }
        
        /* FPS counter */
        .fps-counter {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: var(--light);
            padding: 5px 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
            z-index: 100;
            display: none;
        }
        
        /* Settings button */
        .settings-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 100;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        .settings-btn:hover {
            transform: scale(1.1);
        }
    </style>
    
    <!-- Non-critical CSS -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Rubik:wght@400;700&display=swap" media="print" onload="this.media='all'">
    
    <!-- Deferred scripts -->
    <script>
        // Redirect logic
        if (window.location.hostname === 'murasakiwastaken.github.io') {
            window.location.href = 'https://murasakiwastaken.vercel.app';
        }
        
        // Load non-critical resources after page load
        function loadDeferredResources() {
            const resources = [
                'https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js',
                'https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js',
                'https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js',
                'https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js',
                'https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js',
                'https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js'
            ];
            
            resources.forEach(src => {
                const script = document.createElement('script');
                script.src = src;
                script.async = true;
                document.body.appendChild(script);
            });
        }
        
       // Initialize Firebase
const firebaseConfig = {
    apiKey: "AIzaSyBcrITBb6ZnwL8QLlBl30L580kJgJDue2k",
    authDomain: "chatroommurasaki.firebaseapp.com",
    projectId: "chatroommurasaki",
    storageBucket: "chatroommurasaki.appspot.com",
    messagingSenderId: "649572971936",
    appId: "1:649572971936:web:5d0aaf1be9f09cb428a0c5",
    measurementId: "G-1113622WQQ"
};

// Wait for Firebase to load properly
function initializeFirebase() {
    if (typeof firebase !== 'undefined' && firebase.apps.length === 0) {
        firebase.initializeApp(firebaseConfig);
        initApplication(); // Start app only after Firebase is ready
    } else {
        setTimeout(initializeFirebase, 100); // Keep checking
    }
}

// Main application initialization
function initApplication() {
    // Now it's safe to use Firebase
    const auth = firebase.auth();
    const database = firebase.database();
    
    // DOM Elements
    const authPage = document.getElementById('auth-page');
    const mainContainer = document.getElementById('main-container');
    // ... rest of your app initialization
}

// Start checking for Firebase
initializeFirebase();

// Load deferred resources after DOM is ready
document.addEventListener('DOMContentLoaded', loadDeferredResources);
    </script>
</head>
<body>
    <!-- Settings Panel -->
    <div class="settings-panel" id="settings-panel">
        <div class="settings-header">
            <h2 class="settings-title">Settings</h2>
            <button class="close-settings" id="close-settings">&times;</button>
        </div>
        
        <div class="settings-section">
            <h3>Appearance</h3>
            <div class="settings-option">
                <label for="dark-mode">Dark Mode</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="dark-mode" checked>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="settings-option">
                <label for="particles-toggle">Particles Effect</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="particles-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="settings-option">
                <label for="fps-counter">Show FPS Counter</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="fps-counter">
                    <span class="slider"></span>
                </label>
            </div>
            
            <h3>Color Scheme</h3>
            <div class="color-scheme-options">
                <div class="color-scheme-option selected" style="background: linear-gradient(135deg, #0f0c29, #302b63)" data-scheme="default"></div>
                <div class="color-scheme-option" style="background: linear-gradient(135deg, #1a2a6c, #b21f1f)" data-scheme="red"></div>
                <div class="color-scheme-option" style="background: linear-gradient(135deg, #11998e, #38ef7d)" data-scheme="green"></div>
                <div class="color-scheme-option" style="background: linear-gradient(135deg, #5433FF, #20BDFF)" data-scheme="blue"></div>
                <div class="color-scheme-option" style="background: linear-gradient(135deg, #8E2DE2, #4A00E0)" data-scheme="purple"></div>
                <div class="color-scheme-option" style="background: linear-gradient(135deg, #f12711, #f5af19)" data-scheme="orange"></div>
            </div>
        </div>
        
        <div class="settings-section">
            <h3>Privacy & Security</h3>
            <div class="settings-option">
                <label for="cloak-toggle">Enable Tab Cloaking</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="cloak-toggle">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="settings-option">
                <label for="about-blank-toggle">About:Blank Cloaking</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="about-blank-toggle">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="settings-option">
                <label for="cloak-site">Cloak as:</label>
                <select id="cloak-site" class="auth-input" style="width: auto; padding: 5px 10px;">
                    <option value="google-classroom">Google Classroom</option>
                    <option value="google-docs">Google Docs</option>
                    <option value="kami">Kami</option>
                    <option value="clever">Clever</option>
                    <option value="google">Google</option>
                </select>
            </div>
            
            <button id="apply-cloak" class="auth-btn" style="padding: 10px; margin-top: 10px;">Apply Cloaking</button>
        </div>
    </div>
    
    <!-- FPS Counter -->
    <div class="fps-counter" id="fps-counter-display">FPS: 0</div>
    
    <!-- Settings Button -->
    <div class="settings-btn" id="settings-btn">
        ‚öôÔ∏è
    </div>

    <!-- Auth Page (shown by default) -->
    <div class="auth-page" id="auth-page">
        <div class="auth-container">
            <!-- Login Form -->
            <div id="login-form">
                <h2 class="auth-title">Login to Your Account</h2>
                <input type="text" id="username" class="auth-input" placeholder="Username" required>
                <input type="password" id="password" class="auth-input" placeholder="Password" required>
                <button id="login-btn" class="auth-btn">Log In</button>
                <div id="auth-status" class="auth-status"></div>
                <p style="text-align: center; color: #e0e1dd;">
                    Don't have an account? <a href="#" id="show-signup" style="color: #00a8ff;">Sign Up</a>
                </p>
            </div>
            
            <!-- Signup Form (hidden by default) -->
            <div id="signup-form" class="hidden">
                <h2 class="auth-title">Create New Account</h2>
                <input type="text" id="new-username" class="auth-input" placeholder="Choose a username" required>
                <input type="password" id="new-password" class="auth-input" placeholder="Create password (min 6 chars)" required>
                <button id="signup-btn" class="auth-btn">Sign Up</button>
                <div id="signup-status" class="auth-status"></div>
                <p style="text-align: center; color: #e0e1dd;">
                    Already have an account? <a href="#" id="show-login" style="color: #00a8ff;">Log In</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Main Content (hidden until auth) -->
    <div class="bg-animation"></div>
    <div class="particles-container" id="particles-js"></div>
    <div class="main-container" id="main-container">
        <header class="header">
            <h1 class="title">murasaki's center v2 | more features!</h1>
        </header>
        
        <div class="tabs">
            <div class="tab active" data-category="all">All Games</div>
            <div class="tab" data-category="arcade">Arcade</div>
            <div class="tab" data-category="sports">Sports</div>
            <div class="tab" data-category="retro">Retro</div>
            <div class="tab" data-category="action">Action</div>
            <div class="tab" data-category="chatroom">Chatroom</div>
            <div class="tab" data-category="ai-assistant">AI Assistant [NEW!]</div>
        </div>
        
        <div class="game-grid">
            <!-- Game cards remain the same as your original -->
            <!-- Slope Game -->
            <div class="game-card" data-category="arcade">
                <img src="https://watchdocumentaries.com/wp-content/uploads/slope-game.jpg" alt="Slope" loading="lazy">
                <div class="game-info">
                    <h3>Slope</h3>
                    <p>Navigate a 3D course at high speed!</p>
                    <a href="#" class="play-btn" data-game="https://slope-game.github.io/rungame/slope/">PLAY NOW</a>
                </div>
            </div>
            
            <!-- Cookie Clicker -->
            <div class="game-card" data-category="arcade">
                <img src="https://www.thumbculture.co.uk/wp-content/uploads/2021/08/Cookies-1024x597.png" alt="Cookie Clicker" loading="lazy">
                <div class="game-info">
                    <h3>Cookie Clicker</h3>
                    <p>Click the cookie to earn points!</p>
                    <a href="#" class="play-btn" data-game="https://cyrillbrito.github.io/cookieclicker/">PLAY NOW</a>
                </div>
            </div>
            
            <!-- Basketball Stars -->
            <div class="game-card" data-category="sports">
                <img src="https://static.keygames.com/5/93515/96655/1200x630/basketball-stars.webp" alt="Basketball Stars" loading="lazy">
                <div class="game-info">
                    <h3>Basketball Stars</h3>
                    <p>1v1 street basketball showdowns!</p>
                    <a href="#" class="play-btn" data-game="https://basketballstarsonline.github.io/file/">PLAY NOW</a>
                </div>
            </div>
            
            <!-- Basketball Random -->
            <div class="game-card" data-category="sports">
                <img src="https://images.crazygames.com/basket-random_16x9/20240617090207/basket-random_16x9-cover?auto=format,compress&q=75&cs=strip" alt="Basketball Random" loading="lazy">
                <div class="game-info">
                    <h3>Basketball Random</h3>
                    <p>Chaotic multiplayer basketball!</p>
                    <a href="#" class="play-btn" data-game="https://basketball-random.github.io/file/">PLAY NOW</a>
                </div>
            </div>
            
            <!-- Penalty Shooters 2 -->
            <div class="game-card" data-category="sports">
                <img src="https://cdn6.aptoide.com/imgs/8/9/e/89e683612d0604ef467252311c614782_screen.jpg?w=324" alt="Penalty Shooters 2" loading="lazy">
                <div class="game-info">
                    <h3>Penalty Shooters 2</h3>
                    <p>Test your penalty shooting skills!</p>
                    <a href="#" class="play-btn" data-game="//html5.gamedistribution.com/rvvASMiM/571b9df027e449f78e3869ba19658754/index.html">PLAY NOW</a>
                </div>
            </div>
            
            <!-- Volley Random -->
            <div class="game-card" data-category="sports">
                <img src="https://images.crazygames.com/volley-random/20230131173658/volley-random-cover?auto=format,compress&q=75&cs=strip" alt="Volley Random" loading="lazy">
                <div class="game-info">
                    <h3>Volley Random</h3>
                    <p>Crazy physics volleyball!</p>
                    <a href="#" class="play-btn" data-game="https://bolaa1.github.io/file/">PLAY NOW</a>
                </div>
            </div>
                  
            <!-- Soccer Random -->
            <div class="game-card" data-category="sports">
                <img src="https://images.crazygames.com/games/soccer-random/cover_16x9-1732744645362.png?auto=format,compress&q=75&cs=strip" alt="Soccer Random" loading="lazy">
                <div class="game-info">
                    <h3>Soccer Random</h3>
                    <p>Fast paced ball kicking (kick my balls preferably too)!</p>
                    <a href="#" class="play-btn" data-game="https://slope-game.github.io/new3723/soccer-random/">PLAY NOW</a>
                </div>
            </div>
            
            <!-- Pac-Man -->
            <div class="game-card" data-category="retro">
                <img src="https://muralsyourway.vtexassets.com/arquivos/ids/274926/Pacman-Game-Wall-Mural.jpg?v=638229015907170000" alt="Pac-Man" loading="lazy">
                <div class="game-info">
                    <h3>Pac-Man</h3>
                    <p>Classic arcade maze chase!</p>
                    <a href="#" class="play-btn" data-game="https://www.google.com/logos/2010/pacman10-i.html">PLAY NOW</a>
                </div>
            </div>
            
            <!-- Minecraft Classic -->
            <div class="game-card" data-category="action">
                <img src="https://img.gamepix.com/games/eaglercraft/cover/eaglercraft.png?w=400&ar=16:10" alt="Minecraft Classic" loading="lazy">
                <div class="game-info">
                    <h3>Minecraft Classic</h3>
                    <p>Browser-based block building!</p>
                    <a href="#" class="play-btn" data-game="https://eaglauncher.vercel.app">PLAY NOW</a>
                </div>
            </div>
            
            <!-- Cluster Rush -->
            <div class="game-card" data-category="action">
                <img src="https://static.hahagames.com/media/2024/05/01/012c0e6b-0438-4b67-a852-029d4082928c.jpg" alt="Cluster Rush" loading="lazy">
                <div class="game-info">
                    <h3>Cluster Rush</h3>
                    <p>Jump on and off speeding trucks!</p>
                    <a href="#" class="play-btn" data-game="https://htmlxm.github.io/h8/cluster-rush/">PLAY NOW</a>
                </div>
            </div>
        </div>
        
        <!-- Chatroom -->
        <div class="chat-container" id="chatroom">
            <div class="chat-header">
                <h2>Community Chat</h2>
            </div>
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-input-area">
                <input type="text" class="chat-input" id="message-input" placeholder="Type your message...">
                <button class="send-btn" id="send-btn">Send</button>
            </div>
        </div>

        <!-- AI Assistant Container -->
        <div class="ai-container" id="ai-assistant">
            <div class="ai-header">
                <h2>murasaki's AI Assistant</h2>
                <p>Ask me anything about our services or get help!</p>
            </div>
            <div class="ai-conversation" id="ai-messages"></div>
            <div class="ai-input-area">
                <input type="text" class="ai-input" id="ai-input" placeholder="Type your question...">
                <button id="ai-attach-btn" class="media-upload-btn" style="margin-right: 1rem;">
                    üìé Attach (redirects to different website)
                </button>
                <button class="ai-send-btn" id="ai-send-btn">Send</button>
            </div>
            <div id="ai-media-preview" class="media-preview"></div>
        </div>
        
        <!-- Username Modal -->
        <div class="username-modal" id="username-modal">
            <div class="username-modal-content">
                <h2>Choose Your Username</h2>
                <p>This name will be displayed with your messages</p>
                <input type="text" class="username-input" id="username-input" placeholder="Enter username..." maxlength="20">
                <button class="set-username-btn" id="set-username-btn">Join Chat</button>
            </div>
        </div>
        
        <!-- Game Modal -->
        <div class="modal">
            <div class="modal-content">
                <button class="close-btn">X</button>
                <iframe class="game-frame" src="" allowfullscreen></iframe>
            </div>
        </div>
    </div>

    <!-- Feedback System -->
    <div class="feedback-btn" id="feedback-btn">
        <span>Feedback</span>
        <i class="feedback-icon">üí¨</i>
    </div>

    <div class="feedback-modal" id="feedback-modal">
        <div class="feedback-modal-content">
            <div class="feedback-header">
                <h3>Community Feedback</h3>
                <button class="close-feedback">&times;</button>
            </div>
            <div class="feedback-messages" id="feedback-messages"></div>
            <div class="feedback-input-area">
                <textarea id="feedback-input" placeholder="Share your feedback..."></textarea>
                <div class="feedback-actions">
                    <label for="media-upload" class="media-upload-btn">
                        <input type="file" id="media-upload" accept="image/*,video/*" style="display: none;">
                        üìé Attach
                    </label>
                    <button id="send-feedback">Send</button>
                </div>
                <div id="media-preview" class="media-preview"></div>
            </div>
        </div>
    </div>

    <!-- Full CSS (non-critical) -->
    <noscript id="deferred-styles">
        <style>
            .bg-animation {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, 
                    #0f0c29 0%, 
                    #1a1a3a 25%, 
                    #24243e 50%, 
                    #302b63 75%, 
                    #24243e 100%);
                background-size: 400% 400%;
                animation: spaceGradient 30s ease infinite;
                z-index: -2;
                opacity: 0.9;
            }
            
            @keyframes spaceGradient {
                0% { background-position: 0% 50%; }
                50% { background-position: 100% 50%; }
                100% { background-position: 0% 50%; }
            }
            
            /* Particles container */
            .particles-container {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: -1;
                pointer-events: none;
            }
            
            /* Header Styles */
            .header {
                text-align: center;
                padding: 2rem 0;
                position: relative;
                z-index: 10;
                animation: windowsFade 0.6s cubic-bezier(0.1, 0.9, 0.2, 1) both;
            }
            
            .title {
                font-family: 'Orbitron', sans-serif;
                font-size: clamp(2rem, 5vw, 3.5rem);
                background: linear-gradient(90deg, var(--primary), var(--secondary));
                -webkit-background-clip: text;
                background-clip: text;
                color: transparent;
                text-shadow: 0 0 15px rgba(0, 168, 255, 0.5);
                animation: pulse 4s infinite alternate;
                margin-bottom: 1rem;
            }
            
            @keyframes pulse {
                0% { transform: scale(1); }
                100% { transform: scale(1.025); }
            }
            
            /* Tabs Navigation */
            .tabs {
                display: flex;
                justify-content: center;
                flex-wrap: wrap;
                gap: 1rem;
                padding: 1rem;
                margin-bottom: 2rem;
                animation: slideIn 0.5s ease-out both;
                animation-delay: 0.2s;
            }
            
            .tab {
                padding: 0.8rem 1.5rem;
                background: rgba(0, 0, 0, 0.5);
                border-radius: 50px;
                cursor: pointer;
                transition: all 0.3s cubic-bezier(0.1, 0.9, 0.2, 1);
                font-weight: bold;
                border: 2px solid transparent;
                will-change: transform, box-shadow;
            }
            
            .tab:hover, .tab.active {
                background: rgba(0, 168, 255, 0.2);
                border-color: var(--primary);
                transform: translateY(-5px);
                box-shadow: 0 10px 20px rgba(0, 168, 255, 0.2);
            }
            
            /* Game Grid */
            .game-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 2rem;
                padding: 1rem;
                width: 100%;
            }
            
            .game-card {
                background: rgba(13, 27, 42, 0.7);
                border-radius: 15px;
                overflow: hidden;
                transition: all 0.4s cubic-bezier(0.1, 0.9, 0.2, 1);
                border: 2px solid rgba(0, 168, 255, 0.3);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                opacity: 0;
                animation: fadeIn 0.6s cubic-bezier(0.1, 0.9, 0.2, 1) forwards;
                will-change: transform, box-shadow;
            }
            
            /* Staggered animation for game cards */
            .game-card:nth-child(1) { animation-delay: 0.1s; }
            .game-card:nth-child(2) { animation-delay: 0.2s; }
            .game-card:nth-child(3) { animation-delay: 0.3s; }
            .game-card:nth-child(4) { animation-delay: 0.4s; }
            .game-card:nth-child(5) { animation-delay: 0.5s; }
            .game-card:nth-child(6) { animation-delay: 0.6s; }
            .game-card:nth-child(7) { animation-delay: 0.7s; }
            .game-card:nth-child(8) { animation-delay: 0.8s; }
            .game-card:nth-child(9) { animation-delay: 0.9s; }
            .game-card:nth-child(10) { animation-delay: 1s; }
            
            .game-card:hover {
                transform: translateY(-10px) scale(1.02);
                box-shadow: 0 15px 30px rgba(0, 168, 255, 0.3);
                border-color: var(--primary);
            }
            
            .game-card img {
                width: 100%;
                height: 180px;
                object-fit: cover;
                transition: transform 0.3s ease;
            }
            
            .game-card:hover img {
                transform: scale(1.05);
            }
            
            .game-info {
                padding: 1rem;
            }
            
            .game-info h3 {
                font-size: 1.2rem;
                margin-bottom: 0.5rem;
                color: var(--primary);
            }
            
            .game-info p {
                color: rgba(224, 225, 221, 0.7);
                font-size: 0.9rem;
                margin-bottom: 1rem;
            }
            
            .play-btn {
                display: inline-block;
                padding: 0.5rem 1rem;
                background: linear-gradient(90deg, var(--primary), var(--secondary));
                color: white;
                border-radius: 50px;
                text-decoration: none;
                font-weight: bold;
                transition: all 0.3s cubic-bezier(0.1, 0.9, 0.2, 1);
            }
            
            .play-btn:hover {
                transform: scale(1.05);
                box-shadow: 0 0 15px rgba(0, 168, 255, 0.5);
            }
            
            /* Chat and AI Containers */
            .chat-container, .ai-container {
                display: none;
                max-width: 800px;
                width: 100%;
                margin: 2rem auto;
                background: rgba(13, 27, 42, 0.8);
                border-radius: 15px;
                border: 2px solid var(--primary);
                box-shadow: 0 5px 15px rgba(0, 168, 255, 0.2);
                overflow: hidden;
                animation: windowsFade 0.5s ease-out both;
            }
            
            .chat-container.active, .ai-container.active {
                display: block;
            }
            
            .chat-header, .ai-header {
                background: rgba(0, 0, 0, 0.5);
                padding: 1rem;
                text-align: center;
                border-bottom: 2px solid var(--primary);
            }
            
            .chat-header h2, .ai-header h2 {
                color: var(--primary);
                font-family: 'Orbitron', sans-serif;
            }
            
            .chat-messages, .ai-conversation {
                height: 400px;
                overflow-y: auto;
                padding: 1rem;
                background: rgba(13, 27, 42, 0.5);
            }
            
            .message, .ai-message {
                margin-bottom: 1rem;
                padding: 0.8rem;
                background: rgba(0, 168, 255, 0.1);
                border-radius: 10px;
                border-left: 3px solid var(--primary);
                animation: fadeIn 0.3s ease-out;
            }
            
            .your-message, .ai-user-message {
                background: rgba(0, 168, 255, 0.2);
                border-left: 3px solid var(--secondary);
            }
            
            .system-message {
                background: rgba(255, 45, 117, 0.1);
                border-left: 3px solid var(--secondary);
            }
            
            .message-username {
                font-weight: bold;
                margin-right: 0.5rem;
            }
            
            .message-time {
                font-size: 0.7rem;
                color: rgba(224, 225, 221, 0.5);
            }
            
            .chat-input-area, .ai-input-area {
                display: flex;
                padding: 1rem;
                background: rgba(0, 0, 0, 0.3);
                border-top: 2px solid var(--primary);
            }
            
            .chat-input, .ai-input {
                flex-grow: 1;
                padding: 0.8rem;
                border: none;
                border-radius: 50px;
                background: rgba(224, 225, 221, 0.1);
                color: var(--light);
                margin-right: 1rem;
                transition: all 0.3s ease;
            }
            
            .chat-input:focus, .ai-input:focus {
                outline: none;
                box-shadow: 0 0 10px rgba(0, 168, 255, 0.5);
            }
            
            .send-btn, .ai-send-btn {
                padding: 0.8rem 1.5rem;
                background: linear-gradient(90deg, var(--primary), var(--secondary));
                color: white;
                border: none;
                border-radius: 50px;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.3s cubic-bezier(0.1, 0.9, 0.2, 1);
            }
            
            .send-btn:hover, .ai-send-btn:hover {
                transform: scale(1.05);
                box-shadow: 0 0 15px rgba(0, 168, 255, 0.5);
            }
            
            /* AI Typing Indicator */
            .ai-typing {
                color: rgba(224, 225, 221, 0.7);
                font-style: italic;
            }
            
            .ai-typing::after {
                content: '...';
                animation: blink 1.5s infinite;
            }
            
            @keyframes blink {
                0%, 100% { opacity: 0.5; }
                50% { opacity: 1; }
            }
            
            .ai-error {
                color: #ff6b6b;
                font-style: italic;
            }
            
            /* Modals */
            .username-modal, .modal {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                display: none;
                justify-content: center;
                align-items: center;
                z-index: 200;
                backdrop-filter: blur(5px);
            }
            
            .username-modal.active, .modal.active {
                display: flex;
                animation: windowsFade 0.3s ease-out;
            }
            
            .username-modal-content {
                background: var(--dark);
                padding: 2rem;
                border-radius: 15px;
                border: 2px solid var(--primary);
                text-align: center;
                max-width: 500px;
                width: 90%;
                animation: windowsFade 0.4s ease-out;
            }
            
            .username-input {
                width: 100%;
                padding: 1rem;
                margin: 1rem 0;
                border-radius: 50px;
                border: none;
                background: rgba(224, 225, 221, 0.1);
                color: var(--light);
                text-align: center;
                font-size: 1.2rem;
                transition: all 0.3s ease;
            }
            
            .username-input:focus {
                outline: none;
                box-shadow: 0 0 10px rgba(0, 168, 255, 0.5);
            }
            
            .set-username-btn {
                padding: 0.8rem 2rem;
                background: linear-gradient(90deg, var(--primary), var(--secondary));
                color: white;
                border: none;
                border-radius: 50px;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.3s cubic-bezier(0.1, 0.9, 0.2, 1);
            }
            
            .set-username-btn:hover {
                transform: scale(1.05);
                box-shadow: 0 0 15px rgba(0, 168, 255, 0.5);
            }
            
            .modal-content {
                width: 90%;
                height: 80%;
                background: var(--dark);
                border-radius: 15px;
                border: 2px solid var(--primary);
                overflow: hidden;
                position: relative;
            }
            
            .close-btn {
                position: absolute;
                top: 1rem;
                right: 1rem;
                background: var(--secondary);
                color: white;
                border: none;
                width: 30px;
                height: 30px;
                border-radius: 50%;
                cursor: pointer;
                z-index: 101;
                transition: all 0.3s ease;
            }
            
            .close-btn:hover {
                transform: scale(1.1);
            }
            
            .game-frame {
                width: 100%;
                height: 100%;
                border: none;
            }
            
            /* Message delete button styles */
            .message {
                position: relative;
                padding-right: 30px;
            }
            
            .delete-message {
                position: absolute;
                right: 10px;
                top: 10px;
                opacity: 0;
                transition: opacity 0.2s;
                background: var(--error);
                color: white;
                border: none;
                width: 20px;
                height: 20px;
                border-radius: 50%;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .message:hover .delete-message {
                opacity: 1;
            }
            
            /* Feedback System */
            .feedback-btn {
                position: fixed;
                bottom: 30px;
                right: 30px;
                background: linear-gradient(90deg, var(--primary), var(--secondary));
                color: white;
                padding: 12px 20px;
                border-radius: 50px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 10px;
                box-shadow: 0 4px 15px rgba(0, 168, 255, 0.3);
                z-index: 1000;
                transition: all 0.4s cubic-bezier(0.1, 0.9, 0.2, 1);
                animation: slideIn 0.5s ease-out both;
                animation-delay: 0.5s;
            }
            
            .feedback-btn:hover {
                transform: translateY(-5px) scale(1.05);
                box-shadow: 0 8px 20px rgba(0, 168, 255, 0.4);
            }
            
            .feedback-modal {
                position: fixed;
                bottom: 90px;
                right: 30px;
                width: 350px;
                max-height: 500px;
                background: rgba(13, 27, 42, 0.95);
                border-radius: 15px;
                border: 2px solid var(--primary);
                box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
                z-index: 1001;
                display: none;
                flex-direction: column;
                overflow: hidden;
                transform-origin: bottom right;
                animation: windowsFade 0.3s ease-out;
            }
            
            .feedback-modal.active {
                display: flex;
            }
            
            .feedback-modal-content {
                display: flex;
                flex-direction: column;
                height: 100%;
            }
            
            .feedback-header {
                padding: 15px;
                background: rgba(0, 0, 0, 0.3);
                border-bottom: 2px solid var(--primary);
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .feedback-header h3 {
                color: var(--primary);
                font-size: 1.1rem;
                margin: 0;
            }
            
            .close-feedback {
                background: none;
                border: none;
                color: var(--light);
                font-size: 1.5rem;
                cursor: pointer;
                padding: 0 5px;
                transition: transform 0.2s ease;
            }
            
            .close-feedback:hover {
                transform: scale(1.2);
            }
            
            .feedback-messages {
                flex-grow: 1;
                padding: 15px;
                overflow-y: auto;
                background: rgba(13, 27, 42, 0.7);
            }
            
            .feedback-message {
                margin-bottom: 10px;
                padding: 10px;
                background: rgba(0, 168, 255, 0.1);
                border-radius: 8px;
                border-left: 3px solid var(--primary);
                animation: fadeIn 0.3s ease-out;
            }
            
            .feedback-message.user {
                background: rgba(0, 168, 255, 0.2);
                border-left: 3px solid var(--secondary);
            }
            
            .feedback-message p {
                margin: 5px 0;
                word-break: break-word;
            }
            
            .feedback-message .message-meta {
                display: flex;
                justify-content: space-between;
                font-size: 0.8rem;
                color: rgba(224, 225, 221, 0.7);
                margin-bottom: 5px;
            }
            
            .feedback-message .media-attachment {
                margin-top: 10px;
                max-width: 100%;
                border-radius: 5px;
            }
            
            .feedback-input-area {
                padding: 15px;
                background: rgba(0, 0, 0, 0.3);
                border-top: 2px solid var(--primary);
            }
            
            .feedback-input-area textarea {
                width: 100%;
                padding: 10px;
                border-radius: 8px;
                border: 1px solid rgba(0, 168, 255, 0.3);
                background: rgba(224, 225, 221, 0.1);
                color: var(--light);
                resize: none;
                min-height: 60px;
                margin-bottom: 10px;
                transition: all 0.3s ease;
            }
            
            .feedback-input-area textarea:focus {
                outline: none;
                box-shadow: 0 0 10px rgba(0, 168, 255, 0.5);
            }
            
            .feedback-actions {
                display: flex;
                justify-content: space-between;
            }
            
            .media-upload-btn {
                padding: 8px 12px;
                background: rgba(0, 168, 255, 0.1);
                border-radius: 5px;
                cursor: pointer;
                color: var(--primary);
                border: 1px dashed var(--primary);
                transition: all 0.2s ease;
            }
            
            .media-upload-btn:hover {
                background: rgba(0, 168, 255, 0.2);
                transform: scale(1.05);
            }
            
            #send-feedback {
                padding: 8px 20px;
                background: linear-gradient(90deg, var(--primary), var(--secondary));
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                transition: all 0.2s cubic-bezier(0.1, 0.9, 0.2, 1);
            }
            
            #send-feedback:hover {
                transform: scale(1.05);
                box-shadow: 0 0 10px rgba(0, 168, 255, 0.5);
            }
            
            .media-preview {
                margin-top: 10px;
                display: none;
                animation: fadeIn 0.3s ease-out;
            }
            
            .media-preview img, .media-preview video {
                max-width: 100%;
                max-height: 150px;
                border-radius: 5px;
                margin-top: 5px;
            }
            
            .remove-media {
                background: var(--error);
                color: white;
                border: none;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                font-size: 12px;
                cursor: pointer;
                margin-left: 5px;
                transition: transform 0.2s ease;
            }
            
            .remove-media:hover {
                transform: scale(1.1);
            }
            
            /* Responsive Adjustments */
            @media (max-width: 768px) {
                .title {
                    font-size: 2.2rem;
                }
                
                .tabs {
                    gap: 0.5rem;
                }
                
                .tab {
                    padding: 0.6rem 1rem;
                    font-size: 0.9rem;
                }
                
                .game-grid {
                    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                }
                
                .feedback-modal {
                    width: 300px;
                    right: 15px;
                    bottom: 80px;
                }
                
                .settings-panel {
                    width: 300px;
                }
                
                .chat-container, .ai-container {
                    margin: 1rem auto;
                }
                
                .chat-messages, .ai-conversation {
                    height: 300px;
                }
            }
            
            @media (max-width: 480px) {
                .title {
                    font-size: 1.8rem;
                }
                
                .game-grid {
                    grid-template-columns: 1fr;
                }
                
                .feedback-modal {
                    width: 280px;
                    right: 10px;
                }
                
                .settings-panel {
                    width: 280px;
                }
                
                .feedback-btn {
                    padding: 10px 15px;
                    right: 15px;
                    bottom: 20px;
                }
                
                .auth-container {
                    padding: 15px;
                }
                
                .chat-input-area, .ai-input-area {
                    flex-direction: column;
                    gap: 10px;
                }
                
                .chat-input, .ai-input {
                    margin-right: 0;
                    margin-bottom: 10px;
                }
            }
        </style>
    </noscript>
    
  <!-- Main JavaScript -->
<script>
    // Initialize Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBcrITBb6ZnwL8QLlBl30L580kJgJDue2k",
        authDomain: "chatroommurasaki.firebaseapp.com",
        projectId: "chatroommurasaki",
        storageBucket: "chatroommurasaki.appspot.com",
        messagingSenderId: "649572971936",
        appId: "1:649572971936:web:5d0aaf1be9f09cb428a0c5",
        measurementId: "G-1113622WQQ"
    };

    // Wait for Firebase to load properly
function initializeFirebase() {
    if (typeof firebase !== 'undefined' && firebase.apps.length === 0) {
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Now it's safe to get auth and database references
        const auth = firebase.auth();
        const database = firebase.database();
        
        // Start the rest of your app
        initApplication(auth, database); // Pass these as parameters
    } else {
        setTimeout(initializeFirebase, 100); // Keep checking
    }
}

// Start checking for Firebase
initializeFirebase();

    // DOM Elements
    const authPage = document.getElementById('auth-page');
    const mainContainer = document.getElementById('main-container');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const showSignup = document.getElementById('show-signup');
    const showLogin = document.getElementById('show-login');
    const loginBtn = document.getElementById('login-btn');
    const signupBtn = document.getElementById('signup-btn');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const newUsernameInput = document.getElementById('new-username');
    const newPasswordInput = document.getElementById('new-password');
    const authStatus = document.getElementById('auth-status');
    const signupStatus = document.getElementById('signup-status');

    // Toggle between login and signup forms
    showSignup.addEventListener('click', (e) => {
        e.preventDefault();
        loginForm.classList.add('hidden');
        signupForm.classList.remove('hidden');
        clearStatus();
    });

    showLogin.addEventListener('click', (e) => {
        e.preventDefault();
        signupForm.classList.add('hidden');
        loginForm.classList.remove('hidden');
        clearStatus();
    });

    // Login function
    loginBtn.addEventListener('click', () => {
        const username = usernameInput.value.trim();
        const password = passwordInput.value.trim();
        
        if (!username || !password) {
            showError(authStatus, 'Please enter both username and password');
            return;
        }
        
        // Using username@example.com as the email
        const email = `${username}@example.com`;
        
        loginBtn.disabled = true;
        loginBtn.textContent = 'Logging in...';
        
        auth.signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                showSuccess(authStatus, 'Login successful!');
                // Hide auth page and show main content
                authPage.style.display = 'none';
                mainContainer.style.display = 'flex';
                loadDeferredStyles();
                initParticles();
                initTabSystem();
                initFeedbackSystem();
                initSettingsPanel();
            })
            .catch((error) => {
                showError(authStatus, getErrorMessage(error));
            })
            .finally(() => {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Log In';
            });
    });
    
    // Signup function
    signupBtn.addEventListener('click', () => {
        const username = newUsernameInput.value.trim();
        const password = newPasswordInput.value.trim();
        
        if (!username || !password) {
            showError(signupStatus, 'Please enter both username and password');
            return;
        }
        
        if (password.length < 6) {
            showError(signupStatus, 'Password must be at least 6 characters');
            return;
        }
        
        // Using username@example.com as the email
        const email = `${username}@example.com`;
        
        signupBtn.disabled = true;
        signupBtn.textContent = 'Creating account...';
        
        auth.createUserWithEmailAndPassword(email, password)
            .then((userCredential) => {
                showSuccess(signupStatus, 'Account created successfully!');
                // Hide auth page and show main content
                authPage.style.display = 'none';
                mainContainer.style.display = 'flex';
                loadDeferredStyles();
                initParticles();
                initTabSystem();
                initFeedbackSystem();
                initSettingsPanel();
            })
            .catch((error) => {
                showError(signupStatus, getErrorMessage(error));
            })
            .finally(() => {
                signupBtn.disabled = false;
                signupBtn.textContent = 'Sign Up';
            });
    });
    
    // Helper functions
    function clearInputs() {
        usernameInput.value = '';
        passwordInput.value = '';
        newUsernameInput.value = '';
        newPasswordInput.value = '';
    }
    
    function clearStatus() {
        authStatus.classList.remove('success', 'error');
        authStatus.style.display = 'none';
        signupStatus.classList.remove('success', 'error');
        signupStatus.style.display = 'none';
    }
    
    function showError(element, message) {
        element.textContent = message;
        element.classList.remove('success');
        element.classList.add('error');
        element.style.display = 'block';
    }
    
    function showSuccess(element, message) {
        element.textContent = message;
        element.classList.remove('error');
        element.classList.add('success');
        element.style.display = 'block';
    }
    
    function getErrorMessage(error) {
        switch (error.code) {
            case 'auth/wrong-password':
                return 'Incorrect password';
            case 'auth/user-not-found':
                return 'Username not found';
            case 'auth/email-already-in-use':
                return 'Username already taken';
            case 'auth/weak-password':
                return 'Password must be at least 6 characters';
            default:
                return 'Login failed. Please try again.';
        }
    }

            const auth = firebase.auth();
            const database = firebase.database();
            const storage = firebase.storage();

            // Load non-critical CSS
            function loadDeferredStyles() {
                const addStylesNode = document.getElementById("deferred-styles");
                const replacement = document.createElement("div");
                replacement.innerHTML = addStylesNode.textContent;
                document.body.appendChild(replacement);
                addStylesNode.parentElement.removeChild(addStylesNode);
            }

            // Initialize FPS counter
            function initFPSCounter() {
                const fpsCounter = document.getElementById('fps-counter-display');
                let lastTime = performance.now();
                let frameCount = 0;
                let fps = 0;

                function updateFPSCounter() {
                    frameCount++;
                    const now = performance.now();
                    const delta = now - lastTime;
                    
                    if (delta >= 1000) {
                        fps = Math.round((frameCount * 1000) / delta);
                        fpsCounter.textContent = `FPS: ${fps}`;
                        frameCount = 0;
                        lastTime = now;
                    }
                    requestAnimationFrame(updateFPSCounter);
                }

                updateFPSCounter();
            }

            // Initialize particles.js
            function initParticles() {
                if (typeof particlesJS !== 'undefined') {
                    particlesJS('particles-js', {
                        "particles": {
                            "number": {
                                "value": 60,  // Reduced for performance
                                "density": {
                                    "enable": true,
                                    "value_area": 800
                                }
                            },
                            "color": {
                                "value": "#ffffff"
                            },
                            "shape": {
                                "type": "circle",
                                "stroke": {
                                    "width": 0,
                                    "color": "#000000"
                                }
                            },
                            "opacity": {
                                "value": 0.5,
                                "random": true,
                                "anim": {
                                    "enable": true,
                                    "speed": 1,
                                    "opacity_min": 0.1,
                                    "sync": false
                                }
                            },
                            "size": {
                                "value": 3,
                                "random": true,
                                "anim": {
                                    "enable": true,
                                    "speed": 2,
                                    "size_min": 0.1,
                                    "sync": false
                                }
                            },
                            "line_linked": {
                                "enable": true,
                                "distance": 150,
                                "color": "#4d8bf0",
                                "opacity": 0.4,
                                "width": 1
                            },
                            "move": {
                                "enable": true,
                                "speed": 1,  // Reduced for performance
                                "direction": "none",
                                "random": true,
                                "straight": false,
                                "out_mode": "out",
                                "bounce": false
                            }
                        },
                        "interactivity": {
                            "detect_on": "canvas",
                            "events": {
                                "onhover": {
                                    "enable": true,
                                    "mode": "grab"
                                },
                                "onclick": {
                                    "enable": true,
                                    "mode": "push"
                                },
                                "resize": true
                            },
                            "modes": {
                                "grab": {
                                    "distance": 140,
                                    "line_linked": {
                                        "opacity": 1
                                    }
                                },
                                "push": {
                                    "particles_nb": 4
                                }
                            }
                        },
                        "retina_detect": true
                    });
                } else {
                    setTimeout(initParticles, 100);
                }
            }

            // Settings panel functionality
            function initSettingsPanel() {
                const settingsPanel = document.getElementById('settings-panel');
                const settingsBtn = document.getElementById('settings-btn');
                const closeSettings = document.getElementById('close-settings');
                const darkModeToggle = document.getElementById('dark-mode');
                const particlesToggle = document.getElementById('particles-toggle');
                const fpsCounterToggle = document.getElementById('fps-counter');
                const colorSchemeOptions = document.querySelectorAll('.color-scheme-option');
                const cloakToggle = document.getElementById('cloak-toggle');
                const aboutBlankToggle = document.getElementById('about-blank-toggle');
                const cloakSiteSelect = document.getElementById('cloak-site');
                const applyCloakBtn = document.getElementById('apply-cloak');
                const fpsCounterDisplay = document.getElementById('fps-counter-display');

                // Load saved settings from localStorage
                function loadSettings() {
                    // Dark mode
                    if (localStorage.getItem('darkMode') === 'false') {
                        darkModeToggle.checked = false;
                        document.body.classList.add('light-mode');
                    }

                    // Particles
                    if (localStorage.getItem('particlesEnabled') === 'false') {
                        particlesToggle.checked = false;
                        document.getElementById('particles-js').style.display = 'none';
                    }

                    // FPS counter
                    if (localStorage.getItem('fpsCounterEnabled') === 'true') {
                        fpsCounterToggle.checked = true;
                        fpsCounterDisplay.style.display = 'block';
                        initFPSCounter();
                    }

                    // Color scheme
                    const savedScheme = localStorage.getItem('colorScheme');
                    if (savedScheme) {
                        document.querySelector(`.color-scheme-option[data-scheme="${savedScheme}"]`).classList.add('selected');
                        applyColorScheme(savedScheme);
                    }

                    // Cloaking settings
                    if (localStorage.getItem('cloakEnabled') === 'true') {
                        cloakToggle.checked = true;
                    }
                    if (localStorage.getItem('aboutBlankEnabled') === 'true') {
                        aboutBlankToggle.checked = true;
                    }
                    if (localStorage.getItem('cloakSite')) {
                        cloakSiteSelect.value = localStorage.getItem('cloakSite');
                    }
                }

                // Apply color scheme
                function applyColorScheme(scheme) {
                    const bgAnimation = document.querySelector('.bg-animation');
                    
                    switch(scheme) {
                        case 'default':
                            bgAnimation.style.background = 'linear-gradient(135deg, #0f0c29 0%, #1a1a3a 25%, #24243e 50%, #302b63 75%, #24243e 100%)';
                            break;
                        case 'red':
                            bgAnimation.style.background = 'linear-gradient(135deg, #1a2a6c 0%, #b21f1f 100%)';
                            break;
                        case 'green':
                            bgAnimation.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';
                            break;
                        case 'blue':
                            bgAnimation.style.background = 'linear-gradient(135deg, #5433FF 0%, #20BDFF 100%)';
                            break;
                        case 'purple':
                            bgAnimation.style.background = 'linear-gradient(135deg, #8E2DE2 0%, #4A00E0 100%)';
                            break;
                        case 'orange':
                            bgAnimation.style.background = 'linear-gradient(135deg, #f12711 0%, #f5af19 100%)';
                            break;
                    }
                }

                // Toggle settings panel
                settingsBtn.addEventListener('click', () => {
                    settingsPanel.classList.toggle('open');
                });

                closeSettings.addEventListener('click', () => {
                    settingsPanel.classList.remove('open');
                });

                // Dark mode toggle
                darkModeToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        document.body.classList.remove('light-mode');
                        localStorage.setItem('darkMode', 'true');
                    } else {
                        document.body.classList.add('light-mode');
                        localStorage.setItem('darkMode', 'false');
                    }
                });

                // Particles toggle
                particlesToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        document.getElementById('particles-js').style.display = 'block';
                        initParticles();
                        localStorage.setItem('particlesEnabled', 'true');
                    } else {
                        document.getElementById('particles-js').style.display = 'none';
                        localStorage.setItem('particlesEnabled', 'false');
                    }
                });

                // FPS counter toggle
                fpsCounterToggle.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        fpsCounterDisplay.style.display = 'block';
                        initFPSCounter();
                        localStorage.setItem('fpsCounterEnabled', 'true');
                    } else {
                        fpsCounterDisplay.style.display = 'none';
                        localStorage.setItem('fpsCounterEnabled', 'false');
                    }
                });

                // Color scheme selection
                colorSchemeOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        colorSchemeOptions.forEach(opt => opt.classList.remove('selected'));
                        option.classList.add('selected');
                        const scheme = option.dataset.scheme;
                        applyColorScheme(scheme);
                        localStorage.setItem('colorScheme', scheme);
                    });
                });

                // Cloaking functionality
                function applyCloaking() {
                    const cloakEnabled = cloakToggle.checked;
                    const aboutBlankEnabled = aboutBlankToggle.checked;
                    const cloakSite = cloakSiteSelect.value;
                    
                    if (!cloakEnabled) {
                        localStorage.removeItem('cloakEnabled');
                        localStorage.removeItem('aboutBlankEnabled');
                        localStorage.removeItem('cloakSite');
                        document.title = "murasaki's center v2 | more features!";
                        return;
                    }
                    
                    localStorage.setItem('cloakEnabled', 'true');
                    localStorage.setItem('aboutBlankEnabled', aboutBlankEnabled ? 'true' : 'false');
                    localStorage.setItem('cloakSite', cloakSite);
                    
                    let title = '';
                    let icon = '';
                    
                    switch(cloakSite) {
                        case 'google-classroom':
                            title = 'Google Classroom';
                            icon = 'https://ssl.gstatic.com/classroom/favicon.png';
                            break;
                        case 'google-docs':
                            title = 'Google Docs';
                            icon = 'https://ssl.gstatic.com/docs/documents/images/kix-favicon7.ico';
                            break;
                        case 'kami':
                            title = 'Kami';
                            icon = 'https://kami.app/favicon.ico';
                            break;
                        case 'clever':
                            title = 'Clever | Portal';
                            icon = 'https://clever.com/favicon.ico';
                            break;
                        case 'google':
                            title = 'Google';
                            icon = 'https://www.google.com/favicon.ico';
                            break;
                    }
                    
                    document.title = title;
                    
                    // Change favicon
                    const link = document.querySelector("link[rel*='icon']") || document.createElement('link');
                    link.type = 'image/x-icon';
                    link.rel = 'shortcut icon';
                    link.href = icon;
                    document.getElementsByTagName('head')[0].appendChild(link);
                    
                    // About:blank cloaking if enabled
                    if (aboutBlankEnabled) {
                        const aboutBlank = window.open('about:blank', '_blank');
                        if (aboutBlank) {
                            aboutBlank.document.write(`
                                <!DOCTYPE html>
                                <html>
                                <head>
                                    <title>${title}</title>
                                    <link rel="icon" href="${icon}">
                                    <style>
                                        body { margin: 0; padding: 0; }
                                        iframe { border: none; width: 100%; height: 100vh; }
                                    </style>
                                </head>
                                <body>
                                    <iframe src="${window.location.href}"></iframe>
                                </body>
                                </html>
                            `);
                            aboutBlank.document.close();
                            window.location.href = 'about:blank';
                        }
                    }
                }
                
                // Apply cloaking button
                applyCloakBtn.addEventListener('click', applyCloaking);
                
                // Load settings when page loads
                loadSettings();
                
                // Apply cloaking if enabled
                if (localStorage.getItem('cloakEnabled') === 'true') {
                    applyCloaking();
                }
            }

            // Main application initialization
            function initApplication() {
                // DOM Elements
                const authPage = document.getElementById('auth-page');
                const mainContainer = document.getElementById('main-container');
                const loginForm = document.getElementById('login-form');
                const signupForm = document.getElementById('signup-form');
                const showSignup = document.getElementById('show-signup');
                const showLogin = document.getElementById('show-login');
                const loginBtn = document.getElementById('login-btn');
                const signupBtn = document.getElementById('signup-btn');
                const usernameInput = document.getElementById('username');
                const passwordInput = document.getElementById('password');
                const newUsernameInput = document.getElementById('new-username');
                const newPasswordInput = document.getElementById('new-password');
                const authStatus = document.getElementById('auth-status');
                const signupStatus = document.getElementById('signup-status');
                
                // Toggle between login and signup forms
                showSignup.addEventListener('click', (e) => {
                    e.preventDefault();
                    loginForm.classList.add('hidden');
                    signupForm.classList.remove('hidden');
                    clearStatus();
                });
                
                showLogin.addEventListener('click', (e) => {
                    e.preventDefault();
                    signupForm.classList.add('hidden');
                    loginForm.classList.remove('hidden');
                    clearStatus();
                });
                
                // Login function
                loginBtn.addEventListener('click', () => {
                    const username = usernameInput.value.trim();
                    const password = passwordInput.value.trim();
                    
                    if (!username || !password) {
                        showError(authStatus, 'Please enter both username and password');
                        return;
                    }
                    
                    // For demo, we'll use username@example.com as the email
                    const email = `${username}@example.com`;
                    
                    loginBtn.disabled = true;
                    loginBtn.textContent = 'Logging in...';
                    
                    auth.signInWithEmailAndPassword(email, password)
                        .then((userCredential) => {
                            showSuccess(authStatus, 'Login successful!');
                            // Hide auth page and show main content
                            authPage.style.display = 'none';
                            mainContainer.style.display = 'flex';
                            loadDeferredStyles();
                            initParticles();
                            initTabSystem();
                            initFeedbackSystem();
                            initSettingsPanel();
                        })
                        .catch((error) => {
                            showError(authStatus, getErrorMessage(error));
                        })
                        .finally(() => {
                            loginBtn.disabled = false;
                            loginBtn.textContent = 'Log In';
                        });
                });
                
                // Signup function
                signupBtn.addEventListener('click', () => {
                    const username = newUsernameInput.value.trim();
                    const password = newPasswordInput.value.trim();
                    
                    if (!username || !password) {
                        showError(signupStatus, 'Please enter both username and password');
                        return;
                    }
                    
                    if (password.length < 6) {
                        showError(signupStatus, 'Password must be at least 6 characters');
                        return;
                    }
                    
                    // For demo, we'll use username@example.com as the email
                    const email = `${username}@example.com`;
                    
                    signupBtn.disabled = true;
                    signupBtn.textContent = 'Creating account...';
                    
                    auth.createUserWithEmailAndPassword(email, password)
                        .then((userCredential) => {
                            showSuccess(signupStatus, 'Account created successfully!');
                            // Hide auth page and show main content
                            authPage.style.display = 'none';
                            mainContainer.style.display = 'flex';
                            loadDeferredStyles();
                            initParticles();
                            initTabSystem();
                            initFeedbackSystem();
                            initSettingsPanel();
                        })
                        .catch((error) => {
                            showError(signupStatus, getErrorMessage(error));
                        })
                        .finally(() => {
                            signupBtn.disabled = false;
                            signupBtn.textContent = 'Sign Up';
                        });
                });
                
                // Helper functions
                function clearInputs() {
                    usernameInput.value = '';
                    passwordInput.value = '';
                    newUsernameInput.value = '';
                    newPasswordInput.value = '';
                }
                
                function clearStatus() {
                    authStatus.classList.remove('success', 'error');
                    authStatus.style.display = 'none';
                    signupStatus.classList.remove('success', 'error');
                    signupStatus.style.display = 'none';
                }
                
                function showError(element, message) {
                    element.textContent = message;
                    element.classList.remove('success');
                    element.classList.add('error');
                    element.style.display = 'block';
                }
                
                function showSuccess(element, message) {
                    element.textContent = message;
                    element.classList.remove('error');
                    element.classList.add('success');
                    element.style.display = 'block';
                }
                
                function getErrorMessage(error) {
                    switch (error.code) {
                        case 'auth/wrong-password':
                            return 'Incorrect password';
                        case 'auth/user-not-found':
                            return 'Username not found';
                        case 'auth/email-already-in-use':
                            return 'Username already taken';
                        case 'auth/weak-password':
                            return 'Password must be at least 6 characters';
                        default:
                            return 'Login failed. Please try again.';
                    }
                }
                
                // ======================
                // TAB SYSTEM
                // ======================
                function initTabSystem() {
                    const tabs = document.querySelectorAll('.tab');
                    const gameCards = document.querySelectorAll('.game-card');
                    const chatContainer = document.getElementById('chatroom');
                    const aiContainer = document.getElementById('ai-assistant');
                    
                    // Function to switch tabs with animation
                    function switchTab(tab) {
                        const category = tab.dataset.category;
                        
                        // Animate out current active content
                        const currentActiveTab = document.querySelector('.tab.active');
                        if (currentActiveTab) {
                            currentActiveTab.classList.remove('active');
                        }
                        
                        // Add active class to new tab with animation
                        tab.classList.add('active');
                        
                        // Hide all containers first with fade out animation
                        if (chatContainer.classList.contains('active')) {
                            chatContainer.style.animation = 'fadeOut 0.3s ease-out forwards';
                            setTimeout(() => {
                                chatContainer.classList.remove('active');
                                chatContainer.style.display = 'none';
                                chatContainer.style.animation = '';
                            }, 300);
                        }
                        
                        if (aiContainer.classList.contains('active')) {
                            aiContainer.style.animation = 'fadeOut 0.3s ease-out forwards';
                            setTimeout(() => {
                                aiContainer.classList.remove('active');
                                aiContainer.style.display = 'none';
                                aiContainer.style.animation = '';
                            }, 300);
                        }
                        
                        gameCards.forEach(card => {
                            if (card.style.display === 'block') {
                                card.style.animation = 'fadeOut 0.3s ease-out forwards';
                                setTimeout(() => {
                                    card.style.display = 'none';
                                    card.style.animation = '';
                                }, 300);
                            }
                        });
                        
                        // Show the selected container with fade in animation
                        setTimeout(() => {
                            if (category === 'chatroom') {
                                chatContainer.style.display = 'block';
                                setTimeout(() => {
                                    chatContainer.classList.add('active');
                                    chatContainer.style.animation = 'fadeIn 0.3s ease-out forwards';
                                    checkUsername();
                                }, 10);
                            } else if (category === 'ai-assistant') {
                                aiContainer.style.display = 'block';
                                setTimeout(() => {
                                    aiContainer.classList.add('active');
                                    aiContainer.style.animation = 'fadeIn 0.3s ease-out forwards';
                                    // Initialize AI if first time
                                    if (document.getElementById('ai-messages').children.length === 0) {
                                        addAIMessage("Hello! I'm murasaki's AI assistant. How can I help you today?");
                                        addAIMessage("For image analysis, this AI is currently unsupported, please use the attach button below to redirect yourself to another website. Thank you for your understanding.", false);
                                    }
                                }, 10);
                            } else {
                                gameCards.forEach(card => {
                                    if (category === 'all' || card.dataset.category === category) {
                                        card.style.display = 'none';
                                        setTimeout(() => {
                                            card.style.display = 'block';
                                            card.style.animation = 'fadeIn 0.3s ease-out forwards';
                                        }, 10);
                                    }
                                });
                            }
                        }, 300);
                    }
                    
                    // Add click event to all tabs
                    tabs.forEach(tab => {
                        tab.addEventListener('click', () => {
                            switchTab(tab);
                        });
                    });
                    
                    // Initialize first tab
                    const initialTab = document.querySelector('.tab.active');
                    if (initialTab) {
                        switchTab(initialTab);
                    }
                    
                    // Game Modal
                    const modal = document.querySelector('.modal');
                    const playBtns = document.querySelectorAll('.play-btn');
                    const closeBtn = document.querySelector('.close-btn');
                    const gameFrame = document.querySelector('.game-frame');
                    
                    playBtns.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.preventDefault();
                            const gameUrl = btn.dataset.game;
                            gameFrame.src = gameUrl;
                            modal.classList.add('active');
                            document.body.style.overflow = 'hidden';
                        });
                    });
                    
                    closeBtn.addEventListener('click', () => {
                        modal.classList.remove('active');
                        gameFrame.src = '';
                        document.body.style.overflow = 'auto';
                    });
                    
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.classList.remove('active');
                            gameFrame.src = '';
                            document.body.style.overflow = 'auto';
                        }
                    });
                }
                
                // ======================
                // CHAT SYSTEM
                // ======================
                const usernameModal = document.getElementById('username-modal');
                const chatUsernameInput = document.getElementById('username-input');
                const setUsernameBtn = document.getElementById('set-username-btn');
                const messageInput = document.getElementById('message-input');
                const sendBtn = document.getElementById('send-btn');
                const chatMessages = document.getElementById('chat-messages');
                const chatRef = database.ref('chat');
                
                let chatUsername = localStorage.getItem('chatUsername') || '';
                
                // Username handling
                function checkUsername() {
                    if (!chatUsername) {
                        usernameModal.classList.add('active');
                        chatUsernameInput.focus();
                    } else {
                        usernameModal.classList.remove('active');
                        loadChatHistory();
                    }
                }
                
                function setUsername() {
                    const newUsername = chatUsernameInput.value.trim();
                    if (newUsername) {
                        chatUsername = newUsername;
                        localStorage.setItem('chatUsername', chatUsername);
                        usernameModal.classList.remove('active');
                        
                        // System welcome message
                        chatRef.push({
                            username: 'System',
                            message: `${chatUsername} joined the chat!`,
                            timestamp: Date.now()
                        });
                        
                        loadChatHistory();
                    }
                }
                
                function loadChatHistory() {
                    chatRef.limitToLast(100).on('value', (snapshot) => {
                        chatMessages.innerHTML = '';
                        
                        snapshot.forEach((childSnapshot) => {
                            const msg = childSnapshot.val();
                            displayMessage({
                                ...msg,
                                key: childSnapshot.key
                            });
                        });
                        
                        scrollToBottom();
                    });
                }
                
                function displayMessage({ username, message, timestamp, key, isSystem }) {
                    const isCurrentUser = username === chatUsername;
                    const isSystemMsg = username === 'System' || username === 'AI Assistant' || isSystem;
                    
                    const messageEl = document.createElement('div');
                    messageEl.className = `message ${isCurrentUser ? 'your-message' : ''} ${isSystemMsg ? 'system-message' : ''}`;
                    
                    const time = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    let deleteBtn = '';
                    if (isCurrentUser && !isSystemMsg) {
                        deleteBtn = `<button class="delete-message" data-key="${key}">√ó</button>`;
                    }
                    
                    messageEl.innerHTML = `
                        ${deleteBtn}
                        <span class="message-username" style="color: ${isSystemMsg ? '#ff2d75' : '#00a8ff'}">${username}:</span>
                        <span class="message-text">${message}</span>
                        <div class="message-time">${time}</div>
                    `;
                    
                    chatMessages.appendChild(messageEl);
                    scrollToBottom();
                    
                    // Add delete event listener if this is the user's message
                    if (isCurrentUser && !isSystemMsg) {
                        messageEl.querySelector('.delete-message').addEventListener('click', (e) => {
                            e.stopPropagation();
                            const messageKey = e.target.getAttribute('data-key');
                            deleteMessage(messageKey);
                        });
                    }
                }
                
                function deleteMessage(messageKey) {
                    if (confirm('Are you sure you want to delete this message?')) {
                        database.ref('chat/' + messageKey).remove()
                            .then(() => {
                                console.log('Message deleted successfully');
                            })
                            .catch((error) => {
                                console.error('Error deleting message:', error);
                            });
                    }
                }
                
                function scrollToBottom() {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
                
                // Send message function
                function sendMessage() {
                    const message = messageInput.value.trim();
                    if (message && chatUsername) {
                        chatRef.push({
                            username: chatUsername,
                            message,
                            timestamp: Date.now()
                        });
                        messageInput.value = '';
                    }
                }
                
                // Event listeners for chat
                setUsernameBtn.addEventListener('click', setUsername);
                chatUsernameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') setUsername();
                });
                sendBtn.addEventListener('click', sendMessage);
                
                messageInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        const message = messageInput.value.trim();
                        if (message && chatUsername) {
                            chatRef.push({
                                username: chatUsername,
                                message,
                                timestamp: Date.now()
                            });
                            messageInput.value = '';
                        }
                    }
                });
                
                // ======================
                // AI ASSISTANT
                // ======================
                function addAIMessage(text, isUser = false) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `ai-message ${isUser ? 'ai-user-message' : ''}`;
                    messageDiv.style.animation = 'fadeIn 0.3s ease-out';
                    messageDiv.innerHTML = `<div class="message-text">${text}</div>`;
                    document.getElementById('ai-messages').appendChild(messageDiv);
                    document.getElementById('ai-messages').scrollTop = document.getElementById('ai-messages').scrollHeight;
                }
                
                // Show typing indicator
                function showTypingIndicator() {
                    const typingDiv = document.createElement('div');
                    typingDiv.className = 'ai-message ai-typing';
                    typingDiv.textContent = 'AI is thinking...';
                    typingDiv.id = 'typing-indicator';
                    typingDiv.style.animation = 'fadeIn 0.3s ease-out';
                    document.getElementById('ai-messages').appendChild(typingDiv);
                    document.getElementById('ai-messages').scrollTop = document.getElementById('ai-messages').scrollHeight;
                    return typingDiv;
                }
                
                // Remove typing indicator
                function removeTypingIndicator() {
                    const typingDiv = document.getElementById('typing-indicator');
                    if (typingDiv) {
                        typingDiv.style.animation = 'fadeOut 0.3s ease-out';
                        setTimeout(() => typingDiv.remove(), 300);
                    }
                }
                
                // Get AI response
                async function getAIResponse(question) {
                    try {
                        const response = await fetch('https://murasakiwastaken.vercel.app/api/ai-proxy', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ question })
                        });
                        
                        if (!response.ok) {
                            throw new Error(`API error: ${response.status}`);
                        }
                        
                        const data = await response.json();
                        return data.response || "I didn't get a response.";
                    } catch (error) {
                        console.error('AI Error:', error);
                        return `Error: ${error.message}`;
                    }
                }
                
                // Handle sending message
                async function handleAIInput() {
                    const question = document.getElementById('ai-input').value.trim();
                    if (!question) return;
                    
                    // Display user message
                    addAIMessage(question, true);
                    
                    // Clear input and show typing indicator
                    document.getElementById('ai-input').value = '';
                    const typingDiv = showTypingIndicator();
                    
                    try {
                        const response = await getAIResponse(question);
                        removeTypingIndicator();
                        addAIMessage(response);
                    } catch (error) {
                        removeTypingIndicator();
                        addAIMessage("Sorry, I couldn't process your request. Please try again.");
                    }
                }
                
                // Event listeners
                document.getElementById('ai-send-btn').addEventListener('click', handleAIInput);
                document.getElementById('ai-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleAIInput();
                });
                
                // Redirect to image analysis service
                document.getElementById('ai-attach-btn').addEventListener('click', () => {
                    if (confirm("Image analysis requires visiting an external site. Proceed?")) {
                        window.location.href = "https://aiassistantbot.pages.dev";
                    }
                });
                
                // ======================
                // FEEDBACK SYSTEM
                // ======================
                function initFeedbackSystem() {
                    const feedbackBtn = document.getElementById('feedback-btn');
                    const feedbackModal = document.getElementById('feedback-modal');
                    const closeFeedback = document.querySelector('.close-feedback');
                    const feedbackInput = document.getElementById('feedback-input');
                    const sendFeedbackBtn = document.getElementById('send-feedback');
                    const feedbackMessages = document.getElementById('feedback-messages');
                    const mediaUpload = document.getElementById('media-upload');
                    const mediaPreview = document.getElementById('media-preview');
                    
                    // Use the same reference as chat for consistency
                    const feedbackRef = database.ref('feedback');
                    let selectedFile = null;
                    let feedbackUsername = auth.currentUser ? auth.currentUser.email.split('@')[0] : '';
                    
                    // Toggle feedback modal
                    feedbackBtn.addEventListener('click', () => {
                        feedbackModal.classList.toggle('active');
                        if (feedbackModal.classList.contains('active')) {
                            loadFeedbackMessages();
                        }
                    });
                    
                    closeFeedback.addEventListener('click', () => {
                        feedbackModal.classList.remove('active');
                    });
                    
                    // Handle file upload
                    mediaUpload.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            selectedFile = file;
                            
                            // Show preview
                            mediaPreview.innerHTML = '';
                            const previewElement = file.type.startsWith('image/') ? 
                                document.createElement('img') : 
                                document.createElement('video');
                            
                            previewElement.src = URL.createObjectURL(file);
                            previewElement.controls = true;
                            
                            const removeBtn = document.createElement('button');
                            removeBtn.className = 'remove-media';
                            removeBtn.innerHTML = '√ó';
                            removeBtn.addEventListener('click', () => {
                                selectedFile = null;
                                mediaUpload.value = '';
                                mediaPreview.style.display = 'none';
                            });
                            
                            const previewContainer = document.createElement('div');
                            previewContainer.appendChild(previewElement);
                            previewContainer.appendChild(removeBtn);
                            mediaPreview.appendChild(previewContainer);
                            mediaPreview.style.display = 'block';
                        }
                    });
                    
                    // Load feedback messages
                    function loadFeedbackMessages() {
                        feedbackRef.limitToLast(50).on('value', (snapshot) => {
                            feedbackMessages.innerHTML = '';
                            snapshot.forEach((childSnapshot) => {
                                const msg = childSnapshot.val();
                                displayFeedbackMessage({
                                    ...msg,
                                    key: childSnapshot.key
                                });
                            });
                            scrollFeedbackToBottom();
                        });
                    }
                    
                    // Display a feedback message
                    function displayFeedbackMessage({ username, message, timestamp, key, mediaUrl, mediaType }) {
                        const isCurrentUser = username === feedbackUsername;
                        
                        const messageEl = document.createElement('div');
                        messageEl.className = `feedback-message ${isCurrentUser ? 'user' : ''}`;
                        messageEl.style.animation = 'fadeIn 0.3s ease-out';
                        
                        const time = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        
                        let mediaHtml = '';
                        if (mediaUrl) {
                            if (mediaType === 'image') {
                                mediaHtml = `<img src="${mediaUrl}" class="media-attachment" alt="Attached image" loading="lazy">`;
                            } else {
                                mediaHtml = `<video src="${mediaUrl}" class="media-attachment" controls></video>`;
                            }
                        }
                        
                        let deleteBtn = '';
                        if (isCurrentUser) {
                            deleteBtn = `<button class="delete-message" data-key="${key}">√ó</button>`;
                        }
                        
                        messageEl.innerHTML = `
                            ${deleteBtn}
                            <div class="message-meta">
                                <span class="message-username">${username}:</span>
                                <span class="message-time">${time}</span>
                            </div>
                            ${message ? `<p class="message-text">${message}</p>` : ''}
                            ${mediaHtml}
                        `;
                        
                        feedbackMessages.appendChild(messageEl);
                        
                        // Add delete handler if current user
                        if (isCurrentUser) {
                            messageEl.querySelector('.delete-message')?.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const messageKey = e.target.getAttribute('data-key');
                                deleteFeedbackMessage(messageKey);
                            });
                        }
                    }
                    
                    // Delete feedback message
                    function deleteFeedbackMessage(messageKey) {
                        if (confirm('Delete this feedback?')) {
                            feedbackRef.child(messageKey).remove();
                        }
                    }
                    
                    // Send feedback
                    function sendFeedback() {
                        const message = feedbackInput.value.trim();
                        if (!message && !selectedFile) return;
                        
                        // Require login to post feedback
                        if (!auth.currentUser) {
                            alert('Please sign in to submit feedback');
                            return;
                        }
                        
                        const feedbackData = {
                            username: feedbackUsername,
                            message,
                            timestamp: Date.now()
                        };
                        
                        // Handle file upload if exists
                        if (selectedFile) {
                            const storageRef = storage.ref(`feedback/${Date.now()}_${selectedFile.name}`);
                            const uploadTask = storageRef.put(selectedFile);
                            
                            uploadTask.on('state_changed',
                                null,
                                (error) => {
                                    console.error('Upload error:', error);
                                    // Send without media if upload fails
                                    feedbackRef.push(feedbackData)
                                        .then(() => {
                                            feedbackInput.value = '';
                                            selectedFile = null;
                                            mediaUpload.value = '';
                                            mediaPreview.style.display = 'none';
                                        });
                                },
                                () => {
                                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                                        feedbackData.mediaUrl = downloadURL;
                                        feedbackData.mediaType = selectedFile.type.startsWith('image/') ? 'image' : 'video';
                                        feedbackRef.push(feedbackData)
                                            .then(() => {
                                                feedbackInput.value = '';
                                                selectedFile = null;
                                                mediaUpload.value = '';
                                                mediaPreview.style.display = 'none';
                                            });
                                    });
                                }
                            );
                        } else {
                            feedbackRef.push(feedbackData)
                                .then(() => {
                                    feedbackInput.value = '';
                                });
                        }
                    }
                    
                    function scrollFeedbackToBottom() {
                        feedbackMessages.scrollTop = feedbackMessages.scrollHeight;
                    }
                    
                    // Event listeners
                    sendFeedbackBtn.addEventListener('click', sendFeedback);
                    feedbackInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            sendFeedback();
                        }
                    });
                    
                    // Update username when auth state changes
                    auth.onAuthStateChanged((user) => {
                        if (user) {
                            feedbackUsername = user.email.split('@')[0];
                            // Load feedback messages when user logs in
                            loadFeedbackMessages();
                        }
                    });
                    
                    // Initial load if already logged in
                    if (auth.currentUser) {
                        loadFeedbackMessages();
                    }
                }
                
                // Initialize the application
                initTabSystem();
                initFeedbackSystem();
                initSettingsPanel();
            }
            
            // Start the application
            initApplication();
        });
    </script>
</body>
</html>
